<tool id="bam_tag_reads" name="Tag alignment files" version="0.1.6">
    <description>from multiple bam files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="0.1.6">tag_reads</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
        tag_reads -t '$tag_file' -a
        #for $element in $alignment_series
            '$element.annotate_with':$element.r_tag:$element.m_tag
        #end for
        $allow_dovetailing
        $keep_suboptimal
        $discarded
        $verified
        -o '$tagged_file'
    ]]></command>
    <inputs>
        <param name="tag_file" argument="--tag_file" type="data" format="bam"/>
        <repeat name="alignment_series" title="Alignments">
            <param name="annotate_with" argument="--annotate_with" type="data" format="bam"/>
            <param type="select" name="r_tag" label="First letter to use for read tag" value="A">
                <expand macro="tag_options"/>
            </param>
            <param type="select" name="m_tag" label="First letter to use for mate tag" value="B">
                <expand macro="tag_options"/>
            </param>
        </repeat>
        <param argument="--allow_dovetailing" type="boolean" truevalue="-d" falsevalue="" label="Allow dovetailing" help="Check this to label reads as proper_pair even if the mates of a pair overlap each other"/>
        <param argument="-k" name="keep_suboptimal" type="boolean" truevalue="-k" falsevalue="" label="Keep suboptimal alternative tags" help="Check this to also keep alternative tags that cannot explain the current read cigar"/>
        <param argument="-wd" name="discarded" type="boolean" truevalue="-wd discarded.bam" falsevalue="" label="Check this to produce an output file containing only the reads with tags that failed validation"/>
        <param argument="-wv" name="verified" type="boolean" truevalue="-wv verified.bam" falsevalue="" label="Check this to produce an output file containing only the reads with tags that pass validation"/>
    </inputs>
    <outputs>
        <data name="tagged_file" format="bam" label="Tagged reads on $on_string"/>
        <data name="verified_file" format="bam" from_work_dir="verified.bam" label="Verified reads/tags on $on_string">
            <filter>verified is True</filter>
        </data>
        <data name="discarded_file" format="bam" from_work_dir="discarded.bam" label="Discarded reads/tags $on_string">
            <filter>verified is True</filter>
        </data>
    </outputs>
    <tests>
        <test> <!-- test that a single read originating from a pasteurianus is properly annotated in a dm6 alignment (should end in verified bam file) -->
            <param name="tag_file" value="dm6.bam" ftype="bam"/>
            <repeat name="alignment_series">
                <param name="annotate_with" value="pasteurianus.bam" ftype="bam"/>
                <param name="r_tag" value="A"/>
                <param name="m_tag" value="B"/>
            </repeat>
            <param name="discarded" value="True"/>
            <param name="verified" value="True"/>
            <output name="tagged_file" file="dm6_tagged_with_a_pasteurianus.bam" ftype="bam" lines_diff="5"/>
            <output name="verified_file" file="dm6_tagged_with_a_pasteurianus_verified.bam" ftype="bam" lines_diff="5"/>
            <output name="discarded_file" file="dm6_tagged_with_a_pasteurianus_discarded.bam" ftype="bam" lines_diff="5"/>
        </test>
        <test> <!-- test that a single read originating from a pasteurianus is annotated in pasteurianus.bam as having homology with dm6, but marked as discarded (should end in discarded bam file) -->
            <param name="tag_file" value="pasteurianus.bam" ftype="bam"/>
            <repeat name="alignment_series">
                <param name="annotate_with" value="dm6.bam" ftype="bam"/>
                <param name="r_tag" value="A"/>
                <param name="m_tag" value="B"/>
            </repeat>
            <param name="discarded" value="True"/>
            <param name="verified" value="True"/>
            <output name="tagged_file" file="a_pasteurianus_tagged_with_dm6.bam" ftype="bam" lines_diff="5" />
            <output name="verified_file" file="a_pasteurianus_tagged_with_dm6_verified.bam" ftype="bam" lines_diff="5"/>
            <output name="discarded_file" file="a_pasteurianus_tagged_with_dm6_discarded.bam" ftype="bam" lines_diff="5"/>
        </test>
    </tests>
    <help><![CDATA[
        usage: tag_reads [-h] -t TAG_FILE -a ANNOTATE_WITH [ANNOTATE_WITH ...] -o
                 OUTPUT_FILE

Tag reads in an alignment file based on other alignment files

optional arguments:
  -h, --help            show this help message and exit
  -t TAG_FILE, --tag_file TAG_FILE
                        Tag reads in this file. (default: None)
  -a ANNOTATE_WITH [ANNOTATE_WITH ...], --annotate_with ANNOTATE_WITH [ANNOTATE_WITH ...]
                        Tag reads in readfile if reads are aligned in these
                        files.Append `:A:B` to tag first letter of tag
                        describing read as A, and first letter of tag
                        describing the mate as B (default: None)
  -o OUTPUT_FILE, --output_file OUTPUT_FILE
                        Write bam file to this path (default: None)

    ]]></help>
</tool>
