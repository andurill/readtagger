<tool id="findcluster" name="Find clusters of reads" version="0.3.23">
    <description>in bam files</description>
    <requirements>
        <requirement type="package" version="0.3.23">readtagger</requirement>
    </requirements>
    <version_command>findcluster --version</version_command>
    <command detect_errors="aggressive"><![CDATA[
        ln -f -s $input input.bam &&
        ln -f -s $input.metadata.bam_index input.bam.bai &&
        findcluster
        --input_path input.bam
        #if $reference_fasta:
            --reference_fasta '$reference_fasta'
        #end if
        --output_bam '$output_bam'
        --output_gff '$output_gff'
        --output_fasta '$output_fasta'
        --sample_name '$input.element_identifier'
        --threads "\${GALAXY_SLOTS:-2}"
    ]]></command>
    <inputs>
        <param name="input" argument="--input_path" type="data" format="bam"/>
        <param argument="--reference_fasta" label="Reference Fasta" help="Reconstructed contigs at clusters will be blasted against this sequence." type="data" format="fasta" optional="True"/>
    </inputs>
    <outputs>
        <data name="output_bam" format="bam" label="findcluster BAM on $on_string"/>
        <data name="output_fasta" format="fasta" label="findcluster contigs on $on_string"/>
        <data name="output_gff" format="gff3" label="findcluster GFF on $on_string"/>
    </outputs>
    <tests>
        <test>
            <param name="input" value="extended_and_annotated_roi.bam" ftype="bam"/>
            <output name="output_bam" file="three_cluster_out.bam" ftype="bam" lines_diff="2"/>
            <output name="output_gff" file="three_cluster_out.gff" ftype="gff3" lines_diff="0"/>
        </test>
        <test>
            <param name="input" value="extended_and_annotated_roi.bam" ftype="bam"/>
            <param name="reference_fasta" value="reference.fasta" ftype="fasta"/>
            <output name="output_bam" file="three_cluster_out.bam" ftype="bam" lines_diff="2"/>
            <output name="output_gff">
                <assert_contents>
                    <has_text text="FBti0019066_rover_Gypsy" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. code-block::

    Usage: findcluster [OPTIONS]

      Find clusters of reads that support a TE insertion.

        Options:
      --input_path PATH               Find cluster in this BAM file.
      --output_bam PATH               Write out BAM file with cluster information
                                      to this path. Reads will have an additional
                                      "CD" tag to indicate the cluster number
      --output_gff PATH               Write out GFF file with cluster information
                                      to this path.
      --sample_name TEXT              Sample name to use when writing out clusters
                                      in GFF file. Default is to infer the name
                                      from the input filename.
      --include_duplicates / --no-include_duplicates
                                      Include reads marked as duplicates when
                                      finding clusters.
      --reference_fasta TEXT          Blast cluster contigs against this fasta
                                      file
      --blastdb TEXT                  Blast cluster contigs against this blast
                                      database
      --threads INTEGER RANGE         Threads to use for cap3 assembly step
      --version                       Show the version and exit.
      --help                          Show this message and exit.


]]></help>
</tool>
